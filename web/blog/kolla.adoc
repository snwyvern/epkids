:linkattrs:
:source-highlighter: rouge

== Kolla



Documentation +
link:https://docs.openstack.org/developer/kolla-ansible/quickstart.html[Quickstart, window="_blank"] +
link:https://rahulait.wordpress.com/2016/09/20/openstack-and-containers-project-kolla/[Overwiew, window="_blank"] +
link:https://greatbsky.github.io/kolla-for-openstack-in-docker/en.html[Kolla from source, window="_blank"] +
link:https://marcelwiget.wordpress.com/2016/08/14/kolla-openstack-in-docker-containers-with-ansible-playbooks/[Kolla/Hetzner, window="_blank"] +

link:https://ask.openstack.org/en/question/100339/how-to-use-latest-kolla-code/[Use Latest, window="_blank"] +

===== Nodes

```
10.0.10.1 c1
192.168.4.2 kolla-op
10.0.6.1 c2
10.0.3.1 c3

#subnets
#192.168.4.0 c1
#192.168.5.0 c2
#192.168.3.0 c3

#10.0.10.0 c1
#10.0.6.0 c2
#10.0.3.0 c3
```

===== /etc/hosts on all hosts
```
88.99.69.170  dockerregistry.ms123.org
10.0.10.1 c1
10.0.6.1 c2
10.0.2.1 c3
```


===== Dependencies on kolla-op

```bash
apt-get install python-pip
pip install -U pip
pip install -U docker-py
apt-get install docker.io python-dev libffi-dev gcc libssl-dev ansible
```


===== on c1

```bash
# Create the drop-in unit directory for docker.service
mkdir -p /etc/systemd/system/docker.service.d

tee /etc/systemd/system/docker.service.d/kolla.conf <<-'EOF'
[Service]
MountFlags=shared
EOF

systemctl daemon-reload
systemctl restart docker.service
```

===== /etc/default/docker
```
DOCKER_OPTS="--mtu 1400 --insecure-registry 10.0.10.1:4000"
```

===== Install kolla

.development
```bash
cd
mkdir -p kolla
cd kolla
rm -rf kolla kolla-ansible
git clone https://github.com/openstack/kolla
git clone https://github.com/openstack/kolla-ansible
cd kolla
git checkout stable/newton
cd ..
pip install -r kolla/requirements.txt -r kolla/test-requirements.txt
pip install kolla/
pip install -r kolla-ansible/requirements.txt 
pip install kolla-ansible/
cp -r kolla-ansible/etc/kolla /etc/kolla/
cp kolla-ansible/ansible/inventory/* .

pip install tox
tox -e genconfig
```

.deployment
```bash
pip install kolla-ansible
cp -r /usr/local/share/kolla/etc_examples/kolla /etc/kolla/
cp /usr/local/share/kolla/ansible/inventory/* .
```

```bash
pip install -U python-openstackclient python-neutronclient
```

===== /usr/local/share/kolla/ansible/inventory/multinode
```
[control]
c1 ansible_port=2122

[network]
c1 ansible_port=2122

[compute]
c2 ansible_port=2122
c3 ansible_port=2122

[storage]
c1 ansible_port=2122

[monitoring]
c1 ansible_port=2122
```


```bash
cp /usr/local/share/kolla/etc_examples/kolla/* /etc/kolla
kolla-genpwd
```

===== /etc/kolla/globals.yml
```
kolla_base_distro: "ubuntu"
kolla_install_type: "binary"

openstack_release: "3.0.2"

enable_haproxy: "no"

#docker_registry: "dockerregistry.ms123.org"
#ocker_namespace: "simpl4"
#docker_registry_username: "simpl4"
#docker_registry_password: "ms123"

neutron_external_interface: "veth0"


kolla_internal_vip_address: "10.0.10.1"
network_interface: "docker0"
kolla_external_vip_address: "88.99.69.170"
kolla_external_vip_interface: "eth0"
```

```bash
#"Checking the network_interface is active" comment out  this task in /usr/local/share/kolla/ansible/inventory/multinode 
kolla-ansible prechecks -i /usr/local/share/kolla/ansible/inventory/multinode a
```

```
#/usr/local/share/kolla-ansible/ansible/roles/nova/defaults/main.yml:placement_api_tag: "3.0.3"
#/usr/local/share/kolla-ansible/ansible/roles/common/defaults/main.yml:fluentd_tag: "master"

kolla-ansible pull -i multinode
kolla-ansible deploy -i multinode
kolla-ansible post-deploy
```


===== install nova-compute-lxd in nova_compute container on (c2,c3)
```bash
d exec --user root -t -i  "compute-container" bash
apt install nova-compute-lxd
cd /etc/nova/
mv nova-compute.conf.dpkg-dist nova-compute.conf
```

/usr/lib/python2.7/dist-packages/nova/virt/lxd/driver.py, line 206-207
```
#self.client = pylxd.Client()
self.client = pylxd.Client( endpoint='https://'+host+':8443', verify=False)
```

===== Enable LXD remote, nova-compute need this
```bash
lxc config set core.https_address "[::]:8443"
lxc config set core.trust_password ms123
lxc remote add c3 10.0.2.1 #own ip
```


```bash
d restart  "compute-container" 
```
